//init
const musicData = {
    "Exit The Premises":`
AUTHOR:Kevin MacLeod
BGM:exitThePremises.mp3
BPM:128
MEASURE:4/4
OFFSET:-0.5

score:
a----------511a--577a-,a----------511a--577a-,a----------511a--577a-,a----------511a--577a-,
a^12---23---14--511a25-577a-,a^16---25---14--511a23-577a-,a^12---23---14--511a25-577a-,a^16-----25-----14-----112213241526,
a--24---24---511a^25--577a25,a--23---23---511a^22--577a22,a--24---24---511a^25--577a25,a--23---23---511a^26--577a26,
a--24---24---511a^25--577a25,a--23---23---511a^22--577a22,a--24---24---511a^25--577a25,a--23---23---511a^26--577a26,
a^13---13-14-15-15511a14-577a^13-,a^12---12---16--511a15-577a^14-,a^13---13-14-15-15511a14-577a^13-,a^12---12-16---16511a15-577a^14-,
a^13---13-14-15-15511a14-577a^13-,a^12---12-16---16511a15-577a^14-,a^13---13-14-15-15511a14-577a^13-,a^12---12-16---16-15-14-,
a^16-12-16-12-16-12511a16-577a^12-,a^16-12-16-12-16-12511a16-577a^12-,a^16-12-16-12-16-12511a16-577a^12-,a^16-12-16-12-16-12-16-12-,
a^612b^667b--24---24---512a^25--567a25,a--23---23---512a^22--567a22,a--24---24---512a^25--567a25,a--23---23---512a^26--567a26,
a--24---24---512a^25--567a25,a--23---23---512a^22--567a22,a--24---24---512a^25--567a25,a--23---23---512a^26--567a26,
a^b^13---13-14-15-15511a14-577a^13-,a^12---12---16--511a15-577a^14-,a^13---13-14-15-15511a14-577a^13-,a^12---12-16---16511a15-577a^14-,
a^13---13-14-15-15511a14-577a^13-,a^12---12-16---16511a15-577a^14-,a^13---13-14-15-15511a14-577a^13-,a^12---12-16^26---16^26-15^25-14^24-,
a^13^26---13^26-14^26-15^26-15^26511a14^26-577a^13^26-,a^12^22---12^22-16^22---16^22511a15^22-577a^14^22-,a^13^26---13^26-14^26-15^26-15^26511a14^26-577a^13^26-,a^12^22---12^22-16^22---16^22511a15^22-577a^14^22-,
a^13^26---13^26-14^26-15^26-15^26511a14^26-577a^13^26-,a^12^22---12^22-16^22---16^22511a15^22-577a^14^22-,a^13^26---13^26-14^26-15^26-15^26511a14^26-577a^13^26-,a^12^22---12^22-16^22---16^22511a15^22-577a^14^22-,
a^23^16---23^16-24^16-25^16-25^16511a24^16-577a^23^16-,a^22^12---22^12-26^12---26^12511a25^12-577a^24^12-,a^23^16---23^16-24^16-25^16-25^16511a24^16-577a^23^16-,a^22^12---22^12-26^12---26^12511a25^12-577a^24^12-,
a^23^16---23^16-24^16-25^16-25^16511a24^16-577a^23^16-,a^22^12---22^12-26^12---26^12511a25^12-577a^24^12-,a^23^16---23^16-24^16-25^16-25^16511a24^16-577a^23^16-,a^22^12---22^12-26^12---26^12511a25^12-577a^24^12-,
a^611b^677b24-24-24-24-25-511a^25-25577a25,a23-23-23-23-22-511a^22-22577a22,a24-24-24-24-25-511a^25-25577a25,a23-23-23-23-26-511a^26-26577a26,
a^24-24-24-24-25-511a^25-25577a25,a23-23-23-23-22-511a^22-22577a22,a24-24-24-24-25-511a^25-25577a25,a23-23-23-23-26-511a^26-26577a26,
a^1524142413241424152514511a^251325577a^1425,a^1523142313231423152214511a^221322577a^1422,a^1524142413241424152514511a^251325577a^1425,a^1523142313231423152614511a^261326577a^1426,
a^1524142413241424152514511a^251325577a^1425,a^1523142313231423152214511a^221322577a^1422,a^1524142413241424152514511a^251325577a^1425,a^1523142313231423152614511a^261326577a^1426,
a^b^512a^567a--------a--611a622a633a644a655a666a,
a^13^26---13^26-14^26-15^26-15^26511a14^26-577a^13^26-,a^12^22---12^22-16^22---16^22511a15^22-577a^14^22-,a^13^26---13^26-14^26-15^26-15^26511a14^26-577a^13^26-,a^12^22---12^22-16^22---16^22511a15^22-577a^14^22-,
a^13^26---13^26-14^26-15^26-15^26511a14^26-577a^13^26-,a^12^22---12^22-16^22---16^22511a15^22-577a^14^22-,a^13^26---13^26-14^26-15^26-15^26511a14^26-577a^13^26-,a^12^22---12^22-16^22---16^22511a15^22-577a^14^22-,
a^23^16---23^16-24^16-25^16-25^16511a24^16-577a^23^16-,a^22^12---22^12-26^12---26^12511a25^12-577a^24^12-,a^23^16---23^16-24^16-25^16-25^16511a24^16-577a^23^16-,a^22^12---22^12-26^12---26^12511a25^12-577a^24^12-,
a^23^16---23^16-24^16-25^16-25^16511a24^16-577a^23^16-,a^22^12---22^12-26^12---26^12511a25^12-577a^24^12-,a^23^16---23^16-24^16-25^16-25^16511a24^16-577a^23^16-,a^22^12---22^12-26^12---26^12511a25^12-577a^24^12-,
a^13^33---13^33-14^34-15^35-15^35511a14^34-577a^13^33-,a^12^32---12^32-16^36---16^36511a15^36-577a^14^36-,a^13^33---13^33-14^34-15^35-15^35511a14^34-577a^13^33-,a^12^32---12^32-16^36---16^36511a15^36-577a^14^36-,
a^13^33---13^33-14^34-15^35-15^35511a14^34-577a^13^33-,a^12^32---12^32-16^36---16^36511a15^36-577a^14^36-,a^13^33---13^33-14^34-15^35-15^35511a14^34-577a^13^33-,a^12^32---12^32-16^36---16^36511a15^36-577a^14^36-,
a^23^43---23^43-24^44-25^45-25^45511a24^44-577a^23^43-,a^22^42---22^42-26^46---26^46511a2/5^46-577a^24^46-,a^23^43---23^43-24^44-25^45-25^45511a24^44-577a^23^43-,a^22^42---22^42-26^46---26^46511a25^46-577a^24^46-,
a^23^43---23^43-24^44-25^45-25^45511a24^44-577a^23^43-,a^22^42---22^42-26^46---26^46511a25^46-577a^24^46-,a^23^43---23^43-24^44-25^45-25^45511a24^44-577a^23^43-,a^22^42---22^42-26^46---26^46511a25^46-577a^24^46-,
a^32-42-33-43-34-44-35-45-36-46-37-47-----677b666b655b644b633b622b------------------------,b
`,

    "Spazzmatica Polka":`
AUTHOR:Kevin MacLeod
BGM:spazzmaticaPolka.mp3
BPM:140
MEASURE:4/4
OFFSET:0

score:
511a^b522b^a533a^b544b^a,577a^b566b^a555a^b544b^a,511a^b522b^a533a^b544b^a,577a^b566b^a555a^b544b^a,
511a^b522b^a533a^b544b^a,577a^b566b^a555a^b544b^a,511a^b522b^a533a^b544b^a,577a^b566b^a555a^b544b^a,
b16-1516-11-,1616141314-12-,-17-1617-15-,1717151415-13-,1116-1516-13-,1616141314-12-,-17-1617-15-,1111121314-17-,
21222324222324252324252625---,27262524262524232524232223---,21222324222425262223242527---,27262524262524232625242321---,
21222324222324252324252625---,27262524262524232423222422---,21222324222425262223242527---,27262524262524232324232122---,
-16-1516-11-,1616141314-12-,-17-1617-15-,1717151415-13-,1116-1516-13-,1616141314-12-,-17-1617-15-,1111121314-17-,
-16^36-15^3516^36-11^31-,16^3616^3614^3413^3314^34-12^32-,-17^37-16^3617^37-15^35-,17^3717^3715^3514^3415^35-13^33-,11^3116^36-15^3516^36-13^33-,16^3616^3614^3413^3314^34-12^32-,-17^37-16^3617^37-15^35-,11^3111^3112^3213^3314^34-17^37-,
21222324222324252324252625---,27262524262524232524232223---,21222324222425262223242527---,27262524262524232625242321---,
21^611a^b22232422^622b^a232425633a^b^23242526644b^a^25---,677a^b^27262524666b^a^26252423655a^b^24232224644b^a^22---,21^611a^b22232422^622b^a242526633a^b^23232425644b^a^27---,677a^b^27262524666b^a^26252423655a^b^23242321644b^a^22---,
21^611a^b22232422^622b^a232425633a^b^23242526644b^a^25---,677a^b^27262524666b^a^26252423655a^b^25242322644b^a^23---,21^611a^b22232422^622b^a242526633a^b^23232425644b^a^27---,677a^b^27262524666b^a^26252423655a^b^26252423644b^a^21---,
21^611a^b22232422^622b^a232425633a^b^23242526644b^a^25---,677a^b^27262524666b^a^26252423655a^b^24232224644b^a^22---,21^611a^b22232422^622b^a242526633a^b^23232425644b^a^27---,677a^b^27262524666b^a^26252423655a^b^23242321a^22---,

`,

    "RetroFuture dirty":`
AUTHOR:Kevin MacLeod
BGM:retroFuture_dirty.mp3
BPM:182
MEASURE:4/4
OFFSET:0

score:
644a633a^655aa-,633a^655a622a^666aa-,622a^666a611a^677aa-,-,
644a633a^655aa-,633a^655a622a^666aa-,622a^666a^522a^566a611a^677a^511a^577aa-,------566a555b544c533d522e511f,
37313431,a^37313431,b^577g^37313431,c^566h^37313431,d^555i^37313431,e^544j^37313431,f^533k^37313431,522l^37---31---34---31--31,
l^47414441,k^511a47414441,j^522b^47414441,i^533c^47414441,h^544d^47414441,g^555e^474144^4141,566f--47---41--4144---41---,fed---cba31^37^41^47--,
611a622b--,633c644d--,655e666f--,------fedcba,677a666b--,655c644d--,633e622f--,------fedcba,
24-------24------22,23--2425---25-------,27---27---27---26--26,26--2423---21-------,24-------24------22,23--2425---25-------,27---27---27---26--26,26--2423---21-------,
24-------24------22,23--2425---25-------,27---27---27---26--26,26--2423---23---21---,24-------24------22,23--2425---25-------,272727-,27^511a522a533a544a-a577a566a555a544a-a,
544a533a^555aa-,533a^555a522a^566aa-,522a^566a511a^577aa-,-,544a533a^555aa-,533a^555a522a^566aa-,522a^566a511a^577aa-,611a622a633a644a-a677a666a655a644a-a,
21---21---22--2324--25,21---21---22--2324--25,21---21---22--2324--25,27--------26--27--------26--27--------26--25---24---23---,
21---21---22--2324--25,21---21---22--2324--25,21---21---22--2324--25,27--------26--27--------26--27--------26--25---24---23---,
21---21---22--2324--25,21---21---22--2324--25,21---21---22--2324--25,27--------26--27--------26--27--------26--25---24---23---,
21---21---22--2324--25,21---21---22--2324--25,21---21---22--2324--25,611a622a633a644a-a677a666a655a644a-a,
24-------614a^24------22,a^23--2425---647a^25-------,a^27---27---614a^27---26--26,a^26--2423---647a^21-------,a^24-------614a^24------22,a^23--2425---647a^25-------,a^27---27---614a^27---26--26,a^26--2423---647a^21-------,
a^24-------614a^24------22,a^23--2425---647a^25-------,a^27---27---614a^27---26--26,a^26--2423---647a^23---21---,a^24-------614a^24------22,a^23--2425---647a^25-------,a^2727614a^27-,a^27^511a522a533a544a-a577a566a555a544a-a,
644a^544a633a^533a^655a^555aa-,633a^533a^655a^555a622a^522a^666a^566aa-,622a^522a^666a^566a611a^511a^677a^577aa-,-,
644a^544a633a^533a^655a^555aa-,633a^533a^655a^555a622a^522a^666a^566aa-,622a^522a^666a^566a611a^511a^677a^577aa-,511a533a555a577a--611a633a655a677a--,
a^21^31---21^31---22^32--23^3324^34--25^35,21^31---21^31---22^32--23^3324^34--25^35,21^31---21^31---22^32--23^3324^34--25^35,27^37--------26^36--27^37--------26^36--27^37--------26^36--25^35---24^34---23^33---,
21^41---21^41---22^42--23^4324^44--25^45,21^41---21^41---22^42--23^4324^44--25^45,21^41---21^41---22^42--23^4324^44--25^45,27^47--------26^46--27^47--------26^46--27^47--------26^46--25^45---24^44---23^43---,
21^31---21^31---22^32--23^3324^34--25^35,21^31---21^31---22^32--23^3324^34--25^35,21^31---21^31---22^32--23^3324^34--25^35,27^37--------26^36--27^37--------26^36--27^37--------26^36--25^35---24^34---23^33---,
21^41---21^41---22^42--23^4324^44--25^45,21^41---21^41---22^42--23^4324^44--25^45,21^41---21^41---22^42--23^4324^44--25^45,611a622a633a644a-a677a666a655a644a-a,
a^21---21---647a^22--2324--25,a^21---21---614a^22--2324--25,a^21---21---647a^22--2324--25,a^27--------26--27--------26--614a^27--------26--25---24---23---,
a^21---21---647a^22--2324--25,a^21---21---614a^22--2324--25,a^21---21---647a^22--2324--25,a^27--------26--27--------26--614a^27--------26--25---24---23---,
a^21---21---647a^22--2324--25,a^21---21---614a^22--2324--25,a^21---21---647a^22--2324--25,a^27--------26--27--------26--614a^27--------26--25---24---23---,
a^21---21---647a^22--2324--25,a^21---21---614a^22--2324--25,a^21---21---647a^22--2324--25,a^511a522a533a544a-a577a566a555a544a-a,
14^24-------614a^14^24------12^22,a^13^23--14^2415^25---647a^15^25-------,a^17^27---17^27---614a^17^27---16^26--16^26,a^17^26--16^2415^23--16647a^15^21--1311---,
a^14^24-------614a^14^24------12^22,a^13^23--14^2415^25---647a^15^25-------,a^17^27---17^27---614a^17^27---16^26--16^26,a^16^26--14^2413^23---647a^11^21-------,
a^14^24-------614a^14^24------12^22,a^13^23--14^2415^25---647a^15^25-------,a^17^27---17^27---614a^17^27---16^26--16^26,a^16^26--14^2415^23--16647a^15^23--1311^21---,
a^14^24-------614a^14^24------12^22,a^13^23--14^2415^25---647a^15^25-------,a^17^2727614a^17^27-,a^27^17^511a522a533a544a-a577a566a555a544a-a,
644a633a^655aa-,633a^655a622a^666aa-,622a^666a611a^677aa-,-,
644a633a^655aa-,633a^655a622a^666aa-,622a^666a611a^677aa-,511a522a533a544a-a577a566a555a544a-a,
644a635a--,
`,

    "Mac n' cheese" : `
AUTHOR:Shawn Wasabi (draft)
BGM:mac_n_cheese.mp3
BPM:124
MEASURE:4/4
OFFSET:0

score:
-,24-24-26-2226-2232-32---,24324236464532-,24-24-26-2226-2232-32---,24324236464532-,
14-171712-1612-1612-17-11-,667a645a633a622a----a^17-17---16---16-14---12---611a---,624a--656a--a^24---22-24-26^677a-,646a--623a--a-31-4233443546-,
14-171712-1612-1612-17-11-,667a645a633a622a----a^17-17---16-16-16-14---12---14---,16-511aa522aa533aa,555a--a--566a--a--577a--a--677a666a655a644a633a622a,
a^535a^635a---11372741a---612a-667a-,--a--577a566a555a^611b,a^624b--656b--2127--b---677a-,646a--623a--a-31-4233443546-,
535a^635a---11372741a---612a-21^24^27-,--a----611b,a^624b--656b--2127--b---,612a---667a---a^11-131517-1513,
----535a^635a^11372741a---612a-667a-,--a--577a566a555a^611b,a^624b--656b--2127--b---677a-,646a--623a--a-31-4233443546-,
535a^635a---11372741a---612a-21^24^27-,--a----611b,a^624b--656b--2127--b---,612a--667a--a^111315171513,
--511a^547a^614a^677a----a,-512a^557a^613a^667a-a,--513a^567a^612a^657a-a--514a^577a^611a^647a,a---514a^612a^577a^677a633a644a-,a--511a^612a^547a^677a633a644a----,----a^577a566a555a^611b,a^624b--656b--2127--b---677a-,646a--623a--a-31-42-33-44,
533a^555b^544c14-171712--1612-1612-17-11-,c^14-171712-1612-1612-17-11-,b^14-171712-1612-1612-17-11-,a^14-171712-1612-1612-17-11-,14-171712-161214-171712-1612,14-171712-161214-171714-1717,a^21^27,22^26------31^32^33,
45^46^47^11-a14-1617-,b^611b-622b633b--657b---b^21^23-25^27-31^32^33-,45^46^47^11-a14-1617-,666a^31323334a^3536666a^31323334a^3536---31^32^33-,
45^46^47^11-a14-1617-,b^611b-622b633b--657b---b^21^23-25^27-31^32^33-,45^46^47^11-a14-1617-,666a^31323334a^3536666a^31323334a^3536444741-,----121431^32^3316,
45^46^47-47-47-577a566a,a^11^17^323334353637657a-----a-31^32^33-,45^46^47---------1617----,666a^31323334a^3536666a^31323334a^3536---31^32^33-,
45^46^47-47-47-577a566a,a^32323636323234-------31^32^33-,45^46^47-47-47-511a522a,a^666a^31323334a^3536666a^31323334a^3536444741^644a-,--a^611a^677a622a^666a^31^32^33,
a^45^46^47-47-47-23^2524,-2411^14^17-22242624^611a,26^624a--656a--a^511a^533b^555b^577a---a-b-677a-,646a--623a533a-555a-a---31^32^33---,
45^46^47-47-47-23^2524,-2411^14^17-22242624,
26-11-15^26-1511-1511261715^2513-,--1213141314131217-1614^24-15^11^2513,17--1422232423-1117-111711-,17--1422232423-2721-27---,
611a^677a-11-a^15^26-1511-1314-15^261615^2516,16141516141516171615141212^241412^11^25-,14--1722232423-1511-111511-,14--1722^312324^3123312721^33-35-36-,
611a^677a^36-11-a^15^26-1511-1511261715^2513-,--1213141314131217-1614^24-15^11^2513,17--1422232423-1117-111711-,17--1422232423-2721-27---,
611a^677a-11-a^15^26-1511-1314-15^261615^2516,16141516141516171615141212^241412^11^25-,14--1722232423-1511-111511-,14--1722232423-2721-27-31^32^33-,
45^46^47^11-a14-1617-,b^611b-622b633b--657b---b^21^23-25^27-31^32^33-,45^46^47^11-a14-1617-,666a^31323334a^3536666a^31323334a^3536---31^32^33-,
45^46^47^11-a14-1617-,b^611b-622b633b--657b---b^21^23-25^27-31^32^33-,45^46^47^11-a14-1617-,666a^31323334a^3536666a^31323334a^3536444741-,----121431^32^3316,
45^46^47-47-47-577a566a,a^11^17^323334353637657a-----a-31^32^33-,45^46^47---------1617----,666a^31323334a^3536666a^31323334a^3536---31^32^33-,
45^46^47-47-47-577a566a,a^32323636323234-------31^32^33-,45^46^47-47-47-511a522a,a^666a^31323334a^3536666a^31323334a^3536444741-,----a^611a^677a622a^666a633a^655a^31^32^33-,
45^46^47^a-47-47-577a566a,a^41-474414121616,-24----2721,15-1115-1515-13-----31^32^33-,45^46^47^24-2424-24--22---577a-566a-,a^13^14^15----12161217---11---,666a-----a--666a-----a--511a-522b-533c-,555d-566e-577f-abcdef511b522b533b555a566a577ab--a^11^12^13--,
25^26^27^a---47---47---35343332,31-----33-----35-----333435343536,34--3435--3433-323331323332,31323332333435343536353433-35^11^12^1337,25^26^27---45-----46-47464544,44-43-424443-41---47--46,
45-46-47-4344-45464746-44-42-44-42-42-41--41--42-,4241-42--43-44-46-44-46-47-45-46-47-45-46-47-46-,
14-----11-12-13-14-----14--12-----14--12-----16--15--14-----,677a^14-----11-12-13-14-----14--12-----15--16-----16--17-----141516,
666a^16---14---15---16---14---15---16---1417161516---15---14---15---12---13---14-------,655b^111211121213121313141314151415-,644b^16-------15--1716151214,633c^1415141312-1415141312-14151413,
622c^13-12-11-14-1413121115-1514131216-1615-14-13-12-13-,cba-,

`, 
};

//canvas starter kit
const canvas = document.getElementById("disp");
const ctx = canvas.getContext("2d");
var ratio;
var resize =()=> {
    canvas.height = document.body.clientHeight; canvas.width = document.body.clientWidth;
    ratio = Math.min(canvas.width / 1100, canvas.height / 1100);
    ctx.translate(canvas.width / 2, canvas.height / 2);
    ctx.scale(ratio, ratio);
}
var mouseState = {}; var keydown = {};
canvas.addEventListener("mousedown", (event)=>{mouseState[["left","wheel","right"][event.button]] = true;});
canvas.addEventListener("mouseup", (event)=>{mouseState[["left","wheel","right"][event.button]] = false;});
document.addEventListener("keydown", (event)=>{keydown[event.key] = true;});
document.addEventListener("keyup", (event)=>{keydown[event.key] = false;});
document.addEventListener("mousemove", (event)=>{mouseX = (event.clientX - canvas.width / 2) / ratio; mouseY = (event.clientY - canvas.height / 2) / ratio;});
var updatePos =()=> {mouseX = (event.changedTouches[0].pageX - canvas.width / 2) / ratio; mouseY = (event.changedTouches[0].pageY - canvas.height / 2) / ratio;};
document.addEventListener("touchstart", (event)=>{mouseState["left"] = true; updatePos();});
document.addEventListener("touchmove", (event)=>{event.preventDefault(); updatePos();}, {passive: false});
document.addEventListener("touchend", (event)=>{mouseState["left"] = false; updatePos();});
window.addEventListener("resize", ()=>{resize()});
canvas.oncontextmenu =()=> {return false;};
resize();
//end kit

document.title = "49"

//initalize
const endless = 464; // for debugging

var vibration, mouseX, playerX, life, beat, timer, nowHazward, lastBeat, lineAlpha, damageEffect, vibration, title, score, hazwards, hazwardList, bullet, bgm, bpm, musicEnd, point, tags, clicked, ended, playerSize, damagedBeat;

function init() {
    beat = startBeat = endless || 0;
    vibration = 0;
    mouseX = mouseY = 0;
    playerX = playerY = targetPlayerX = targetPlayerY = 0;
    life = 1;
    timer = 0;
    nowHazward = 0;
    lastBeat = -1;
    lineAlpha = 0;
    damageEffect = 0;
    vibration = 0;
    score = [];
    hazwards = [];
    hazwardList = [];
    bullet = [];
    musicEnd = false;
    point = damage = rank = 0;
    tags = {};
    clicked = false;
    ended = false;
    playerSize = 1;
    damagedBeat = -Infinity;
}

init();

var audio = {};
var canplay = {};
audio["finger01.mp3"] = new Audio(`sounds/finger01.mp3`);
Object.values(musicData).forEach(x=>{audio[x.match(/bgm:(.*)/i)[1]] = new Audio(`sounds/${x.match(/bgm:(.*)/i)[1]}`); canplay[x.match(/bgm:(.*)/i)[1]] = false;});
Object.keys(audio).forEach(x=>audio[x].addEventListener("canplaythrough", ()=>canplay[x] = true));

ctx.__proto__.line =(x0, y0, x1, y1)=> {
    ctx.beginPath();
    ctx.moveTo(x0, y0);
    ctx.lineTo(x1, y1);
    ctx.closePath();
    ctx.stroke();
};

var easing =(i, max, pattern)=> {
    i = Math.max(0, Math.min(i/max, 1));
    switch (pattern) {
        case 1: i = i ** 1.5; break;
        case 2: i = i ** 2; break;
        case 3: i = i ** 3; break;
        case 4: i = (-i) ** 7 +1; break;
        case 5: i = (-i + 1) ** 5; break;
    }
    return Math.max(0, Math.min(i, 1));
}

var getDist =(x0, y0, x1, y1, x2, y2)=> {
    if ((x0 - x1) * x0 + (y0 - y1) * y0 + -(x0 - x1) * x2 + -(y0 - y1) * y2 > 0 == (x0 - x1) * x1 + (y0 - y1) * y1 + -(x0 - x1) * x2 + -(y0 - y1) * y2 > 0) {
        if (((x0 - x2) ** 2 + (y0 - y2) ** 2) ** 0.5 < ((x1 - x2) ** 2 + (y1 - y2) ** 2) ** 0.5) return ((x0 - x2) ** 2 + (y0 - y2) ** 2) ** 0.5;
        else return ((x1 - x2) ** 2 + (y1 - y2) ** 2) ** 0.5;
    }
    return Math.abs((y0 - y1) * x2 + (x1 - x0) * y2 + -(x1 - x0) * y0 + -(y0 - y1) * x0) / ((y0 - y1) ** 2 + (x1 - x0) ** 2) ** 0.5;
}

var drawLines =()=> {
    if (beat >= 0 && Math.floor(beat) != lastBeat) {lineAlpha = 5; playerSize = 1.25; lastBeat = Math.floor(beat);}
    lineAlpha += (0.5 - lineAlpha) / 5;
    ctx.globalAlpha = lineAlpha;
    ctx.strokeStyle = "#ffffff";
    ctx.fillStyle = "#ffffff";
    ctx.lineWidth = 4;
    for (let i = -4; i < 4; i++) {ctx.line(i*100+50,-350,i*100+50,350); ctx.line(-350,i*100+50,350,i*100+50);}
    ctx.font = "30px 'Hiragino Mincho Pro'";
    ctx.fillText(Math.floor(beat*1000)/1000,-400,-400);
    ctx.textAlign = "right";
    ctx.fillText(`♫${title}`,400,425);
    let progress = audio[bgm].currentTime / audio[bgm].duration;
    switch(Math.floor(progress / 0.25)) {
        case 3: ctx.line(-375,375,-375,375-750*Math.min(progress-0.75,0.25)*4);
        case 2: ctx.line(375,375,375-750*Math.min(progress-0.5,0.25)*4,375);
        case 1: ctx.line(375,-375,375,-375+750*Math.min(progress-0.25,0.25)*4);
        case 0: ctx.line(-375,-375,-375+750*Math.min(progress,0.25)*4,-375);
    }
}

var drawHazards =()=> {
    ctx.strokeStyle = ctx.fillStyle = "#00ccb0";
    ctx.lineWidth = 3;
    while (hazwards[nowHazward] && hazwards[nowHazward][hazwards[nowHazward].length-1] < beat) {
        hazwards[nowHazward][hazwards[nowHazward].length-1] += 4;
        if (beat >= startBeat - 4) {
            if (["1","2","3","4","5","6"].indexOf(hazwards[nowHazward][0]) > -1) hazwardList.push([...hazwards[nowHazward],0]);
            else tags[hazwards[nowHazward][0]] = beat;
        }
        nowHazward++;
    }
    let delList = [];
    let addVib = 0;
    let isBurning = false;
    hazwardList.forEach((x,y)=>{
        if (["1","2","3","4"].indexOf(x[0]) > -1) {
            ctx.globalAlpha = Math.max(0, 1 - (x[2] - beat) / 2);
            ctx.beginPath();
            let pos;
            switch (x[0]) {
                case "1": pos = [-400+x[1]*100,-400+easing(x[2]-beat,2,1)*-200]; ctx.line(-400+x[1]*100,-350,-400+x[1]*100,350); break;
                case "2": pos = [-400+x[1]*100,400+easing(x[2]-beat,2,1)*200]; ctx.line(-400+x[1]*100,-350,-400+x[1]*100,350); break;
                case "3": pos = [-400+easing(x[2]-beat,2,1)*-200,-400+x[1]*100]; ctx.line(-350,-400+x[1]*100,350,-400+x[1]*100); break;
                case "4": pos = [400+easing(x[2]-beat,2,1)*200,-400+x[1]*100]; ctx.line(-350,-400+x[1]*100,350,-400+x[1]*100); break;
            }
            ctx.arc(...pos,40,0,Math.PI*2,false);
            ctx.closePath();
            ctx.fill();
            if (beat >= x[2]) {
                delList.unshift(y);
                bullet.push([...pos,0,0,1,0]); bullet.push([...pos,0,0,-1,0]); bullet.push([...pos,0,0,0,1]); bullet.push([...pos,0,0,0,-1]);
                addVib += 16;
            }
        } if (["5","6"].indexOf(x[0]) > -1) {
            if (x[5] == 2) {
                ctx.globalAlpha = easing(beat - x[4], 1, 5);
                switch (x[0]) {
                    case "5": ctx.fillRect(-400+((x[1]*1+x[2]*1)/2-easing(beat-x[4],1,5)*(x[2]-x[1]+1)/2)*100,canvas.height/2/-ratio,(x[2]-x[1]+1)*100*easing(beat-x[4],1,5)/1,canvas.height/ratio); break;
                    case "6": ctx.fillRect(canvas.width/2/-ratio,-400+((x[1]*1+x[2]*1)/2-easing(beat-x[4],1,5)*(x[2]-x[1]+1)/2)*100,canvas.width/ratio,(x[2]-x[1]+1)*100*easing(beat-x[4],1,5)/1); break;
                }
                if (beat - x[4] > 1) delList.unshift(y);
            } else if (beat >= x[4]) {
                ctx.globalAlpha = 1;
                if (x[5] == 0) {addVib += 25; hazwardList[y][5] = 1; tags[x[3]] = Infinity;}
                if (((Math.round(playerX) >= x[1] && Math.round(playerX) <= x[2] && x[0] == "5") || (Math.round(playerY) >= x[1] && Math.round(playerY) <= x[2] && x[0] == "6")) && beat - damagedBeat >= 2) {
                    life -= 0.25;
                    damage += 0.25;
                    addVib += 100;
                    damageEffect += 0.5;
                    damagedBeat = beat;
                }
                isBurning = true;
                switch (x[0]) {
                    case "5": ctx.fillRect(-400+((x[1]*1+x[2]*1)/2-easing(x[4]+1-beat,1,4)*(x[2]-x[1]+1)/2)*100,canvas.height/2/-ratio,(x[2]-x[1]+1)*100*easing(x[4]+1-beat,1,4)/1,canvas.height/ratio*easing(x[4]+1-beat,1,4)*1.5); break;
                    case "6": ctx.fillRect(canvas.width/2/-ratio,-400+((x[1]*1+x[2]*1)/2-easing(x[4]+1-beat,1,4)*(x[2]-x[1]+1)/2)*100,canvas.width/ratio*easing(x[4]+1-beat,1,4)*1.5,(x[2]-x[1]+1)*100*easing(x[4]+1-beat,1,4)/1); break;
                }
                if (beat >= tags[x[3]]) {addVib += 16; hazwardList[y][5] = 2; hazwardList[y][4] = tags[x[3]]}
            } else {
                ctx.globalAlpha = 0.2 + Math.cos((x[4]+beat)*Math.PI*2) * 0.15;
                switch (x[0]) {
                    case "5": ctx.fillRect(-450+x[1]*100,-350,(x[2]-x[1])*100+100,700); break;
                    case "6": ctx.fillRect(-350,-450+x[1]*100,700,(x[2]-x[1])*100+100); break;
                }
                ctx.globalAlpha = Math.max(0, 1 - (x[4] - beat) / 4);
                switch (x[0]) {
                    case "5": ctx.fillRect(-450+x[1]*100,canvas.height/2/-ratio,(x[2]-x[1])*100+100,200*(beat+4-x[4])/4); break;
                    case "6": ctx.fillRect(canvas.width/2/-ratio,-450+x[1]*100,200*(beat+4-x[4])/4,(x[2]-x[1])*100+100); break;
                }
            }
        }
    });
    if (isBurning) addVib += 0.25;
    delList.forEach(x=>hazwardList.splice(x,1));
    delList = [];
    ctx.globalAlpha = 1;
    bullet.forEach((x,y)=>{
        ctx.beginPath();
        ctx.arc(x[0],x[1],10,0,Math.PI*2,false);
        ctx.closePath();
        ctx.fill();
        bullet[y][0] += bullet[y][2] += bullet[y][4];
        bullet[y][1] += bullet[y][3] += bullet[y][5];
        if (getDist(...lastPos, -400+playerX*100, -400+playerY*100, bullet[y][0], bullet[y][1]) < 35) {
            if (beat - damagedBeat >= 2) {
                life -= 0.25;
                damage += 0.25;
                addVib += 100;
                damageEffect += 0.5;
                damagedBeat = beat;
            }
            delList.unshift(y);
        }
        if (Math.abs(x[0]) > canvas.width / ratio / 2 || Math.abs(x[1]) > canvas.height / ratio / 2) delList.unshift(y);
    });
    delList.forEach(x=>bullet.splice(x,1));
    damageEffect = Math.min(damageEffect, 0.75);
    vibration += addVib ** 0.5;
}

var drawPlayer =()=> {
    lastPos = [-400+playerX*100, -400+playerY*100];
    playerSize += (1 - playerSize) / 10;
    life = Math.max(Math.min(life + (beat - damagedBeat >= 16 ? 0.0003 : 0), 1), 0);
    ctx.globalAlpha = beat - damagedBeat >= 2 ? 1 : ((beat - damagedBeat) % 0.25 < 0.125 ? 0.5 : 0.8);
    ctx.fillStyle = "#00ccb0";
    ctx.beginPath();
    targetPlayerX = Math.min(Math.max(Math.round((mouseX + 400) / 100),1),7);
    targetPlayerY = Math.min(Math.max(Math.round((mouseY + 400) / 100),1),7);
    playerX += (targetPlayerX - playerX) / 2;
    playerY += (targetPlayerY - playerY) / 2;
    ctx.arc(-400+playerX*100,-400+playerY*100,35*playerSize,0,Math.PI*2,false);
    ctx.closePath();
    ctx.fill();
    ctx.fillStyle = "#00ffdd";
    ctx.beginPath();
    ctx.moveTo(-400+playerX*100,-400+playerY*100);
    ctx.arc(-400+playerX*100,-400+playerY*100,25*playerSize,Math.PI/-2+Math.PI*2*life,Math.PI/-2,true);
    ctx.closePath();
    ctx.fill();
    ctx.fillStyle = "#ffffff";
    ctx.globalAlpha = damageEffect;
    ctx.fillRect(-canvas.width / 2 / ratio, -canvas.height / 2 / ratio, canvas.width / ratio, canvas.height / ratio);
    damageEffect += (0 - damageEffect) / 10;
}

var drawResults =()=> {
    if (!endless && (musicEnd || life <= 0 || hazwards[hazwards.length-1][hazwards[hazwards.length-1].length-1] < beat)) {
        if (!musicEnd) {
            musicEnd = true;
            point = [Math.floor(beat*1000)/1000, Math.floor(damage*1000)/1000, hazwards[hazwards.length-1][hazwards[hazwards.length-1].length-1]];
            if (point[2] <= point[0]) {
                if (point[1] == 0) rank = "SSS";
                else if (point[1] < 1) rank = "SS";
                else if (point[1] < 3) rank = "S";
                else rank = "A";
            } else {
                if (point[0] > point[2] * 0.75) rank = "B";
                else if (point[0] > point[2] * 0.5) rank = "C";
                else if (point[0] > point[2] * 0.25) rank = "D";
                else rank = "E";
            }
        }
        audio[bgm].volume = Math.max(audio[bgm].volume - 0.0025, 0);
        ctx.fillStyle = "#202020";
        ctx.globalAlpha = 1 - audio[bgm].volume;
        ctx.fillRect(-canvas.width / 2 / ratio, -canvas.height / 2 / ratio, canvas.width / ratio, canvas.height / ratio);
        ctx.fillStyle = "#ffffff"
        ctx.font = "140px 'Hiragino Mincho Pro'";
        ctx.textAlign = "center"
        ctx.fillText("Results", 0, -200);
        ctx.font = "70px 'Hiragino Mincho Pro'";
        ctx.fillText(`final score: ${point[0]}`, 0, 0);
        ctx.fillText(`damages you got: ${point[1]}`, 0, 100);
        ctx.font = "100px 'Hiragino Mincho Pro'";
        ctx.fillText(`RANK: ${rank}`, 0, 250);
        ctx.font = "30px 'Hiragino Mincho Pro'";
        if (ended || audio[bgm].volume <= 0) {
            audio[bgm].pause();
            ctx.fillText(`~click to back~`,400,375);
            ended = true;
        }
        ctx.textAlign = "right";
        ctx.fillText(`♫${title}`,400,425);
    }
}

function board() {
    ctx.globalAlpha = 1;
    ctx.clearRect(-canvas.width / 2 / ratio, -canvas.height / 2 / ratio, canvas.width / ratio, canvas.height / ratio);
    ctx.save();
    let rand = Math.random() * Math.PI * 2;
    ctx.translate(vibration * Math.sin(rand), vibration * Math.cos(rand));
    timer = (new Date().getTime() - startTime) / 1000;
    beat = timer / (60 / bpm);
    drawHazards();
    drawLines();
    drawPlayer();
    ctx.restore();
    drawResults();
    vibration += (0 - vibration) / 5;
    if (ended && mouseState.left) {
        audio["finger01.mp3"].play();
        ended = false;
        audio[bgm].volume = 1;
        select();
    } else requestAnimationFrame(board);
}

function start(soundTrack) {
    init();
    beat = startBeat;
    bpm = musicData[soundTrack].match(/bpm:(.*)/i)[1] * 1;
    startTime = 2500 + musicData[soundTrack].match(/offset:(.*)/i)[1] * 1 - (beat * (60 / bpm)) * 1000 + new Date().getTime();
    measure = musicData[soundTrack].match(/measure:(.*)\/(.*)/i).slice(1,3);
    score = (musicData[soundTrack].match(/score:\n?((.|\n)*)/i)[1].split(",")).map(x=>x.match(/\^?(-|[a-z]|[1-4][1-7]|[5-6][1-7]{2}[a-z])/g));
    title = `${soundTrack} by ${musicData[soundTrack].match(/author:(.*)/i)[1]}`;
    if (score[score.length-1] == null) score.splice(score.length-1,1);
    score.forEach((x,j)=>{
        for (let i = score[j].length - 1; i > 0; i--) {
            if (score[j][i].charAt(0) == "^") {
                score[j][i-1] += x[i];
                score[j].splice(i,1);
            }
        }
        score[j] = score[j].map(x=>x.split("^"));
    })
    score.forEach((x,j)=>{
        x.forEach((x,i)=>{
            x.forEach(x=>{
                if (x != "-") hazwards.push([...x.split(""), measure[0] * (4 / measure[1]) / score[j].length * i + measure[0] * (4 / measure[1]) * j - (["1","2","3","4","5","6"].indexOf(x.charAt(0)) > -1) * measure[0] * (4 / measure[1])]);
            });
        });
    });
    hazwards.sort((x,y)=>{return x[x.length-1] > y[y.length-1] ? 1 : x[x.length-1] < y[y.length-1] ? -1 : 0});
    bgm = musicData[soundTrack].match(/bgm:(.*)/i)[1];
    audio[bgm].currentTime = beat * (60 / bpm);
    board();
}

function select() {
    ctx.globalAlpha = 1;
    ctx.clearRect(-canvas.width / 2 / ratio, -canvas.height / 2 / ratio, canvas.width / ratio, canvas.height / ratio);
    ctx.fillStyle = "#ffffff";
    ctx.strokeStyle = "#ffffff";
    ctx.lineWidth = 3;
    ctx.font = "45px 'Hiragino Mincho Pro'";
    ctx.textAlign = "left";
    let selected = Math.floor((mouseY+402.5) / 75);
    Object.keys(musicData).forEach((x,y) => {
        ctx.fillText(`${x} by ${musicData[x].match(/author:(.*)/i)[1]}`,-350,-350+y*75);
        if (y == selected) ctx.strokeText(`${x} by ${musicData[x].match(/author:(.*)/i)[1]}`,-350,-350+y*75);
    });
    selected = Object.keys(musicData)[selected];
    ctx.beginPath();
    ctx.moveTo(-470,mouseY-25);
    ctx.lineTo(-425,mouseY);
    ctx.lineTo(-470,mouseY+25);
    ctx.closePath();
    ctx.fill();
    ctx.font = "30px 'Hiragino Mincho Pro'";
    ctx.fillText(`~click to start~`,300,425);
    let bgm = selected ? musicData[selected].match(/bgm:(.*)/i)[1] : 0;
    ctx.fillStyle = "#888888";
    ctx.textAlign = "center";
    ctx.fillText(bgm? canplay[bgm] ? "loaded" : "loading" : "", -450, mouseY-45);
    if (canplay[bgm] && mouseState.left) {
        audio["finger01.mp3"].play();
        setTimeout(()=>audio[bgm].play(),2500);
        canvas.onclick = "";
        start(selected);
    }
    else requestAnimationFrame(select);
}

select();
